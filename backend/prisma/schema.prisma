// Prisma Schema for OmniFlow API
// Database: SQLite (development) -> PostgreSQL (production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// User accounts (sub-accounts in the system)
model Account {
  id            String    @id @default(uuid())
  email         String    @unique
  externalId    String?   @unique // External identifier from client system

  // Circle Wallet info
  walletAddress String?   @unique

  // Metadata
  metadata      Json?

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  deposits      Deposit[]
  payouts       Payout[]
  transfersFrom Transfer[] @relation("TransferFrom")
  transfersTo   Transfer[] @relation("TransferTo")

  @@map("accounts")
}

// Deposits (incoming funds to the platform)
model Deposit {
  id              String   @id @default(uuid())
  accountId       String

  // Amount and currency
  expectedAmount  String?  // Expected amount (optional, for tracking)
  receivedAmount  String?  // Actual received amount
  creditedAmount  String?  // Amount credited after fees
  currency        String   @default("USDC")

  // Source chain info
  sourceChain     String
  sourceAddress   String?  // Address that sent the deposit

  // Fee
  feePercent      String   @default("0.4")
  feeAmount       String?

  // Status
  status          DepositStatus @default(AWAITING)

  // Transaction info
  txHash          String?

  // Metadata
  metadata        Json?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime?

  // Relations
  account         Account  @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([status])
  @@map("deposits")
}

enum DepositStatus {
  AWAITING
  PROCESSING
  COMPLETED
  FAILED
}

// Payouts (outgoing payments from the platform)
model Payout {
  id                String       @id @default(uuid())
  accountId         String
  batchId           String?      // For batch payouts

  // Amount
  amount            String       // Amount recipient will receive
  currency          String       @default("USDC")

  // Destination
  destinationAddress String
  destinationChain   String
  destinationToken   String?     // If converting (e.g., ETH, USDT)

  // Fee
  feePercent        String       @default("0.4")
  feeAmount         String?
  totalDeducted     String?      // Total deducted from account balance

  // Status
  status            PayoutStatus @default(PENDING)

  // Transaction info
  txHash            String?

  // Metadata
  metadata          Json?

  // Timestamps
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  completedAt       DateTime?
  estimatedCompletion DateTime?

  // Relations
  account           Account      @relation(fields: [accountId], references: [id])
  batch             PayoutBatch? @relation(fields: [batchId], references: [id])

  @@index([accountId])
  @@index([batchId])
  @@index([status])
  @@map("payouts")
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Batch payouts
model PayoutBatch {
  id            String   @id @default(uuid())
  accountId     String

  // Status
  status        PayoutBatchStatus @default(PENDING)

  // Totals
  totalAmount   String?
  totalFees     String?

  // Metadata
  metadata      Json?

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  completedAt   DateTime?

  // Relations
  payouts       Payout[]

  @@index([accountId])
  @@index([status])
  @@map("payout_batches")
}

enum PayoutBatchStatus {
  PENDING
  PROCESSING
  COMPLETED
  PARTIAL
  FAILED
}

// Internal transfers (between OmniFlow accounts)
model Transfer {
  id              String         @id @default(uuid())
  fromAccountId   String
  toAccountId     String

  // Amount
  amount          String
  currency        String         @default("USDC")

  // Fee (0 for internal transfers)
  feeAmount       String         @default("0")

  // Status
  status          TransferStatus @default(PENDING)

  // Metadata
  metadata        Json?

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  completedAt     DateTime?

  // Relations
  fromAccount     Account        @relation("TransferFrom", fields: [fromAccountId], references: [id])
  toAccount       Account        @relation("TransferTo", fields: [toAccountId], references: [id])

  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([status])
  @@map("transfers")
}

enum TransferStatus {
  PENDING
  COMPLETED
  FAILED
}

// Webhooks configuration
model Webhook {
  id            String   @id @default(uuid())
  url           String
  events        String   // JSON array of event types
  secret        String   // For signature verification

  // Status
  isActive      Boolean  @default(true)

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("webhooks")
}

// Webhook delivery log
model WebhookDelivery {
  id            String   @id @default(uuid())
  webhookId     String
  eventType     String
  payload       Json

  // Delivery info
  httpStatus    Int?
  response      String?
  attempts      Int      @default(0)

  // Status
  delivered     Boolean  @default(false)

  // Timestamps
  createdAt     DateTime @default(now())
  lastAttemptAt DateTime?
  deliveredAt   DateTime?

  @@index([webhookId])
  @@index([delivered])
  @@map("webhook_deliveries")
}
