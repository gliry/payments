// OmniFlow API - Non-Custodial Cross-Chain USDC Payments
// Database: SQLite (dev) -> PostgreSQL (production)

generator client {
  provider = "prisma-client"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
}

// =============================================
// USER & AUTH
// =============================================

model User {
  id String @id @default(uuid())

  username String @unique

  // Passkey credential (registered client-side via Circle SDK)
  credentialId String @unique
  publicKey    String

  // MSCA wallet address (deterministic via CREATE2, same on all chains)
  walletAddress String @unique

  // Server-generated delegate EOA for Gateway burn intent signing
  delegateAddress      String @unique
  delegateEncryptedKey String // AES-256-GCM encrypted private key

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  delegateSetups DelegateSetup[]
  operations     Operation[]
  webhooks       Webhook[]

  @@map("users")
}

// =============================================
// DELEGATE SETUP PER CHAIN
// =============================================

model DelegateSetup {
  id     String              @id @default(uuid())
  userId String
  chain  String
  status DelegateSetupStatus @default(PENDING)

  txHash       String?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, chain])
  @@index([userId])
  @@map("delegate_setups")
}

enum DelegateSetupStatus {
  PENDING
  AWAITING_SIGNATURE
  SUBMITTED
  CONFIRMED
  FAILED
}

// =============================================
// OPERATIONS (Collect, Send, Bridge)
// =============================================

model Operation {
  id     String          @id @default(uuid())
  userId String
  type   OperationType
  status OperationStatus @default(PREPARING)

  params       Json
  summary      Json?
  signRequests Json?

  feeAmount  String?
  feePercent String?

  metadata     Json?
  errorMessage String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  user  User            @relation(fields: [userId], references: [id])
  steps OperationStep[]

  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("operations")
}

enum OperationType {
  COLLECT
  SEND
  BRIDGE
}

enum OperationStatus {
  PREPARING
  AWAITING_SIGNATURE
  SUBMITTED
  PROCESSING
  AWAITING_SIGNATURE_PHASE2
  SUBMITTED_PHASE2
  COMPLETED
  FAILED
  CANCELLED
}

model OperationStep {
  id          String     @id @default(uuid())
  operationId String
  stepIndex   Int
  chain       String
  type        StepType
  status      StepStatus @default(PENDING)

  callData   Json?
  txHash     String?
  userOpHash String?

  burnIntentData    Json?
  attestation       String?
  operatorSignature String?

  errorMessage String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  operation Operation @relation(fields: [operationId], references: [id])

  @@index([operationId])
  @@map("operation_steps")
}

enum StepType {
  APPROVE
  DEPOSIT
  APPROVE_AND_DEPOSIT
  ADD_DELEGATE
  BURN_INTENT
  WAIT_ATTESTATION
  MINT
  TRANSFER
}

enum StepStatus {
  PENDING
  AWAITING_SIGNATURE
  SUBMITTED
  CONFIRMED
  FAILED
  SKIPPED
}

// =============================================
// WEBHOOKS
// =============================================

model Webhook {
  id       String  @id @default(uuid())
  userId   String
  url      String
  events   String
  secret   String
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User              @relation(fields: [userId], references: [id])
  deliveries WebhookDelivery[]

  @@index([userId])
  @@map("webhooks")
}

model WebhookDelivery {
  id         String @id @default(uuid())
  webhookId  String
  eventType  String
  payload    Json
  httpStatus Int?
  response   String?
  attempts   Int     @default(0)
  delivered  Boolean @default(false)

  createdAt     DateTime  @default(now())
  lastAttemptAt DateTime?
  deliveredAt   DateTime?

  webhook Webhook @relation(fields: [webhookId], references: [id])

  @@index([webhookId])
  @@index([delivered])
  @@map("webhook_deliveries")
}
